<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.defectscan.mapper.ImgMapper">

    <!--    数据库参数与Img实体类参数映射-->
    <resultMap id="ImgResultMap" type="com.defectscan.entity.Img">
        <id property="id" column="id"/>
        <result property="imageName" column="imageName"/>
        <result property="localDir" column="localDir"/>
        <result property="backupUrl" column="backupUrl"/>
        <result property="detectTime" column="detectTime"/>
        <result property="defectCount" column="defectCount"/>
        <result property="defectTypeId" column="defectTypeId"/>
        <result property="createTime" column="createTime"/>
        <result property="updateTime" column="updateTime"/>
        <result property="createUser" column="createUser"/>
        <result property="updateUser" column="updateUser"/>
        <result property="mark" column="mark"/>
        <result property="isOpe" column="isOpe"/>
        <result property="isShow" column="isShow"/>
        <result property="isBackup" column="isBackup"/>
    </resultMap>


    <!--    数据库参数与ImgResultMap实体类参数映射-->
    <resultMap id="ReturnPageImgResultMap" type="com.defectscan.vo.ReturnPageImgVO">
        <id property="id" column="id"/>
        <result property="imageName" column="imageName"/>
        <result property="aliyunUrl" column="aliyunUrl"/>
        <result property="detectTime" column="detectTime"/>
        <result property="defectCount" column="defectCount"/>
        <result property="defectType" column="defectTypeId"/>
        <result property="createTime" column="createTime"/>
        <result property="updateTime" column="updateTime"/>
        <result property="createUser" column="createUser"/>
        <result property="updateUser" column="updateUser"/>
        <result property="mark" column="mark"/>
    </resultMap>

<!--    添加图片信息-->
    <insert id="addImg" parameterType="com.defectscan.entity.Img">
        INSERT INTO imgs (
            imageName, localDir, aliyunUrl, backupUrl, detectTime,
            defectCount, defectTypeId, createTime, updateTime, createUser,
            updateUser, mark, isOpe, isShow, isBackup
        )
        VALUES (
                   #{imageName}, #{localDir}, #{aliyunUrl},#{backupUrl},
                   #{detectTime}, #{defectCount},#{defectTypeId}, #{createTime},
                   #{updateTime}, #{createUser},#{updateUser},
                   #{mark}, #{isOpe}, #{isShow}, #{isBackup}
               );
    </insert>


    <!-- 检测后将图片数据更新 -->
    <update id="updateImgDetect" parameterType="com.defectscan.entity.Img">
        UPDATE imgs
        <trim prefix="SET" suffixOverrides=",">
            <if test="detectTime != null and detectTime != ''">
                detectTime = #{detectTime},
            </if>
            <if test="defectCount != null and defectCount != ''">
                defectCount = #{defectCount},
            </if>
            <if test="defectTypeId != null and defectTypeId != ''">
                defectTypeId = #{defectTypeId},
            </if>
            <if test="updateTime != null">
                updateTime = #{updateTime},
            </if>
            <if test="updateUser != null and updateUser != ''">
                updateUser = #{updateUser},
            </if>
            <if test="isDetect != null and isDetect != ''">
                isDetect = #{isDetect},
            </if>
        </trim>
        WHERE id = #{id}
    </update>


<!--    根据url查询图片数据-->
    <select id="selectAiDetectDTOByUrl" parameterType="string" resultType="com.defectscan.dto.AiDetectDTO">
        SELECT id, aliyunUrl
        FROM imgs
        <where>
            <if test="localDir != null and localDir != ''">
                localDir = #{localDir}
            </if>
            <if test="aliyunUrl != null and aliyunUrl != ''">
                or aliyunUrl = #{aliyunUrl}
            </if>
        </where>
    </select>


<!--    图片分页查询-->
<!--    查询总数据量-->
    <select id="pageSum" parameterType="com.defectscan.vo.ImgPageQueryVO" resultType="long">
        select count(*) from imgs
        <where>
            <if test="start != null and start != '' and end != null and end != ''">
                AND updateTime BETWEEN #{start} AND #{end}
            </if>
            <if test="createUser != null and createUser != ''">
                AND createUser LIKE CONCAT('%', #{createUser}, '%')
            </if>
            <if test="defectType != null and defectType != ''">
                AND FIND_IN_SET(#{defectType}, defectTypeId) > 0
            </if>
        </where>
    </select>



<!--    查询当前页数据列表-->
    <select id="pageQuery" resultMap="ReturnPageImgResultMap">
        select id, imageName,aliyunUrl,detectTime, defectCount,defectTypeId, createTime, updateTime, createUser, updateUser, mark
        from imgs
        <where>
            <if test="a.start != null and a.start != '' and a.end != null and a.end != ''">
                AND updateTime BETWEEN #{a.start} AND #{a.end}
            </if>
            <if test="a.createUser != null and a.createUser != ''">
                AND createUser LIKE CONCAT('%', #{a.createUser}, '%')
            </if>
            <if test="a.defectType != null and a.defectType != ''">
                AND FIND_IN_SET(#{a.defectType}, defectTypeId) > 0
            </if>
        </where>
        limit #{startIndex}, #{pageSize}
    </select>



    <select id="findImgById" parameterType="java.lang.Long" resultType="com.defectscan.entity.Img">
        select * from imgs
        <where>
            id = #{id}
        </where>
    </select>

    <select id="findImgByUsername" parameterType="string" resultType="com.defectscan.entity.Img">
        select * from imgs
        <where>
            createUser = #{username}
        </where>
    </select>

    <select id="isExist" parameterType="int" resultType="int">
        select count(*) from imgs
        <where>
            id = #{id}
        </where>
    </select>


    <update id="updateImg" parameterType="com.defectscan.entity.Img">
        UPDATE imgs
        <trim prefix="SET" suffixOverrides=",">
            <if test="imageName != null and imageName != ''">
                imageName = #{imageName},
            </if>
            <if test="localDir != null and localDir != ''">
                localDir = #{localDir},
            </if>
            <if test="aliyunUrl != null and aliyunUrl != ''">
                aliyunUrl = #{aliyunUrl},
            </if>
            <if test="backupUrl != null and backupUrl != ''">
                backupUrl = #{backupUrl},
            </if>
            <if test="detectTime != null and detectTime != ''">
                detectTime = #{detectTime},
            </if>
            <if test="defectCount != null and defectCount != ''">
                defectCount = #{defectCount},
            </if>
            <if test="defectTypeId != null and defectTypeId != ''">
                defectTypeId = #{defectTypeId},
            </if>
            <if test="createTime != null">
                createTime = #{createTime},
            </if>
            <if test="updateTime != null">
                updateTime = #{updateTime},
            </if>
            <if test="createUser != null and createUser != ''">
                createUser = #{createUser},
            </if>
            <if test="updateUser != null and updateUser != ''">
                updateUser = #{updateUser},
            </if>
            <if test="mark != null and mark != ''">
                mark = #{mark},
            </if>
            <if test="isDetect != null and isDetect != ''">
                isDetect = #{isDetect},
            </if>
            <if test="isOpe != null and isOpe != ''">
                isOpe = #{isOpe},
            </if>
            <if test="isShow != null and isShow != ''">
                isShow = #{isShow},
            </if>
            <if test="isBackup != null and isBackup != ''">
                isBackup = #{isBackup},
            </if>
        </trim>
        WHERE id = #{id}
    </update>


    <delete id="deleteImg" parameterType="com.defectscan.entity.Img">
        delete from imgs
        <where>
            id = #{a.id}
        </where>
    </delete>

</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.defectscan.mapper.ImgMapper">

<!--    数据库参数与Img实体类参数映射-->
    <resultMap id="ImgResultMap" type="com.defectscan.entity.Img">
        <id property="id" column="id"/>
        <result property="imageName" column="imageName"/>
        <result property="originalLocalUrl" column="originalLocalUrl"/>
        <result property="originalAliyunUrl" column="originalAliyunUrl"/>
        <result property="detectLocalUrl" column="detectLocalUrl"/>
        <result property="detectAliyunUrl" column="detectAliyunUrl"/>
        <result property="detectTime" column="detectTime"/>
        <result property="defectTagId" column="defectTagId"/>
        <result property="defectCount" column="defectCount"/>
        <result property="confidenceLevel" column="confidenceLevel"/>
        <result property="createTime" column="createTime"/>
        <result property="updateTime" column="updateTime"/>
        <result property="createUser" column="createUser"/>
        <result property="updateUser" column="updateUser"/>
        <result property="mark" column="mark"/>
        <result property="isOpe" column="isOpe"/>
        <result property="isShow" column="isShow"/>
    </resultMap>

<!--    添加图片信息-->
    <insert id="addImg" parameterType="com.defectscan.entity.Img">
        INSERT INTO imgs (
            imageName, originalLocalUrl, originalAliyunUrl,
            detectLocalUrl, detectAliyunUrl, detectTime,
            defectTagId, defectCount, confidenceLevel,
            createTime, updateTime, createUser,
            updateUser, mark, isOpe, isShow
        )
        VALUES (
                   #{imageName}, #{originalLocalUrl}, #{originalAliyunUrl},
                   #{detectLocalUrl}, #{detectAliyunUrl}, #{detectTime},
                   #{defectTagId}, #{defectCount}, #{confidenceLevel},
                   #{createTime}, #{updateTime}, #{createUser},
                   #{updateUser}, #{mark}, #{isOpe}, #{isShow}
               );
    </insert>


    <!-- 检测后将图片数据更新 -->
    <update id="updateImgDetect" parameterType="com.defectscan.entity.Img">
        UPDATE imgs
        <trim prefix="SET" suffixOverrides=",">
            <if test="detectLocalUrl != null and detectLocalUrl != ''">
                detectLocalUrl = #{detectLocalUrl},
            </if>
            <if test="detectAliyunUrl != null and detectAliyunUrl != ''">
                detectAliyunUrl = #{detectAliyunUrl},
            </if>
            <if test="detectTime != null and detectTime != ''">
                detectTime = #{detectTime},
            </if>
            <if test="defectTagId != null and defectTagId != ''">
                defectTagId = #{defectTagId},
            </if>
            <if test="defectCount != null and defectCount != ''">
                defectCount = #{defectCount},
            </if>
            <if test="confidenceLevel != null and confidenceLevel != ''">
                confidenceLevel = #{confidenceLevel},
            </if>
            <if test="updateTime != null">
                updateTime = #{updateTime},
            </if>
            <if test="updateUser != null and updateUser != ''">
                updateUser = #{updateUser},
            </if>
            <if test="isDetect != null and isDetect != ''">
                isDetect = #{isDetect},
            </if>
            <if test="isOpe != null and isOpe != ''">
                isOpe = #{isOpe}
            </if>
        </trim>
        WHERE id = #{id} AND imageName = #{imageName}
    </update>


<!--    根据url查询图片数据-->
    <select id="selectImgByUrl" parameterType="string" resultType="com.defectscan.entity.Img">
        SELECT *
        FROM imgs
        <where>
            <if test="originalLocalUrl != null and originalLocalUrl != ''">
                and originalLocalUrl = #{url}
            </if>
            <if test="originalAliyunUrl != null and originalAliyunUrl != ''">
                or originalAliyunUrl = #{url}
            </if>
        </where>
    </select>


<!--    图片分页查询-->
<!--    查询总数据量-->
    <select id="pageSum" parameterType="com.defectscan.dto.ImgPageQueryDTO" resultType="long">
        select count(*) from imgs
        <where>
            <if test="defectTagId != null and defectTagId != ''">
                -- 假设数据库中缺陷类型id也是以逗号分隔存储
                AND FIND_IN_SET(defectTagId, #{defectTagId}) > 0
            </if>
            <if test="defectCount != null and defectCount != ''">
                AND defectCount = #{defectCount}
            </if>
            <if test="confidenceLevel != null and confidenceLevel != ''">
                AND confidenceLevel = #{confidenceLevel}
            </if>
            <if test="start != null and start != '' and end != null and end != ''">
                AND updateTime BETWEEN #{start} AND #{end}
            </if>
            <if test="createUser != null and createUser != ''">
                AND createUser LIKE CONCAT('%', #{createUser}, '%')
            </if>
            <if test="mark != null and mark != ''">
                AND mark LIKE CONCAT('%', #{mark}, '%')
            </if>
            <if test="isDetect != null and isDetect != ''">
                AND isDetect = #{isDetect}
            </if>
            <if test="isOpe != null and isOpe != ''">
                AND isOpe = #{isOpe}
            </if>
        </where>
    </select>
<!--    查询当前页数据列表-->
    <select id="pageQuery" resultMap="ImgResultMap">
        select * from imgs
        <where>
            <if test="a.defectTagId != null and a.defectTagId != ''">
                -- 假设数据库中缺陷类型id也是以逗号分隔存储
                AND FIND_IN_SET(defectTagId, #{a.defectTagId}) > 0
            </if>
            <if test="a.defectCount != null and a.defectCount != ''">
                AND defectCount = #{a.defectCount}
            </if>
            <if test="a.confidenceLevel != null and a.confidenceLevel != ''">
                AND confidenceLevel = #{a.confidenceLevel}
            </if>
            <if test="a.start != null and a.start != '' and a.end != null and a.end != ''">
                AND updateTime BETWEEN #{a.start} AND #{a.end}
            </if>
            <if test="a.createUser != null and a.createUser != ''">
                AND createUser LIKE CONCAT('%', #{a.createUser}, '%')
            </if>
            <if test="a.mark != null and a.mark != ''">
                AND mark LIKE CONCAT('%', #{a.mark}, '%')
            </if>
            <if test="a.isDetect != null and a.isDetect != ''">
                AND isDetect = #{a.isDetect}
            </if>
            <if test="a.isOpe != null and a.isOpe != ''">
                AND isOpe = #{a.isOpe}
            </if>
        </where>
        limit #{startIndex}, #{pageSize}
    </select>

    <select id="findImgById" parameterType="java.lang.Long" resultType="com.defectscan.entity.Img">
        select * from imgs
        <where>
            id = #{id}
        </where>
    </select>



    <update id="updateImg" parameterType="com.defectscan.entity.Img">
        UPDATE imgs
        <trim prefix="SET" suffixOverrides=",">
            <if test="imageName != null and imageName != ''">
                imageName = #{imageName},
            </if>
            <if test="originalLocalUrl != null and originalLocalUrl != ''">
                originalLocalUrl = #{originalLocalUrl},
            </if>
            <if test="originalAliyunUrl != null and originalAliyunUrl != ''">
                originalAliyunUrl = #{originalAliyunUrl},
            </if>
            <if test="detectLocalUrl != null and detectLocalUrl != ''">
                detectLocalUrl = #{detectLocalUrl},
            </if>
            <if test="detectAliyunUrl != null and detectAliyunUrl != ''">
                detectAliyunUrl = #{detectAliyunUrl},
            </if>
            <if test="detectTime != null and detectTime != ''">
                detectTime = #{detectTime},
            </if>
            <if test="defectTagId != null and defectTagId != ''">
                defectTagId = #{defectTagId},
            </if>
            <if test="defectCount != null and defectCount != ''">
                defectCount = #{defectCount},
            </if>
            <if test="confidenceLevel != null and confidenceLevel != ''">
                confidenceLevel = #{confidenceLevel},
            </if>
            <if test="createTime != null">
                createTime = #{createTime},
            </if>
            <if test="updateTime != null">
                updateTime = #{updateTime},
            </if>
            <if test="createUser != null and createUser != ''">
                createUser = #{createUser},
            </if>
            <if test="updateUser != null and updateUser != ''">
                updateUser = #{updateUser},
            </if>
            <if test="mark != null and mark != ''">
                mark = #{mark},
            </if>
            <if test="isDetect != null and isDetect != ''">
                isDetect = #{isDetect},
            </if>
            <if test="isOpe != null and isOpe != ''">
                isOpe = #{isOpe},
            </if>
            <if test="isShow != null and isShow != ''">
                isShow = #{isShow},
            </if>
        </trim>
        WHERE id = #{id}
    </update>


    <delete id="deleteImg" parameterType="com.defectscan.entity.Img">
        delete from imgs
        <where>
            id = #{id}
        </where>
    </delete>

</mapper>